    pipeline {
    agent any

    tools {
        maven "Maven"
    }
    
    stages {
        stage('Clone the code') {
            steps {
                git branch: 'master',
                   //credentialsId: 'amitgithub',
                   url: 'https://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@github.com/amitithelpdesk/new-spring-bbot-sonar.git'
            }
        }
        stage('build the code') {
            steps {
                sh 'mvn clean install'
            }
        }
		
        
		stage('docker build') {
            steps {
                sh 'docker build -t gcr.io/concise-haven-327611/new-app:${BUILD_NUMBER} .'
				sh 'gcloud auth activate-service-account devops@concise-haven-327611.iam.gserviceaccount.com --key-file=concise-haven-327611-236df64dbf41.json'
				sh 'cat concise-haven-327611-236df64dbf41.json | docker login -u _json_key --password-stdin https://gcr.io'
				sh 'docker push gcr.io/concise-haven-327611/new-app:${BUILD_NUMBER} '
				
			
				
		
            }
        }
		stage('kubernetes connect and deploy') {
            steps {
                sh 'gcloud container clusters get-credentials cluster-1 --zone us-central1-c --project concise-haven-327611'
                sh "sed -i 's/00/${BUILD_NUMBER}/g' my-app-deploy.yml"
				sh 'kubectl apply -f my-app-deploy.yml'
				sh 'kubectl apply -f my-app-service.yml'
			
				
		
            }
        }
	
    }
}
